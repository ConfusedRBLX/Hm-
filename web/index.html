<!DOCTYPE html>
<html>
<head>
<title>3d audio live stream</title>
</head>
<body oncontextmenu="event.preventDefault();">
<button oncontextmenu="event.preventDefault();" onclick="doit(this);">connect</button>
<script>
var queue = [];

var avgDecodeTime = 0;
var lastDecodeTime = Date.now();

var context=new AudioContext(),
    panner=context.createPanner(),
    generator = new MediaStreamTrackGenerator({ kind: 'audio' }),
    writer = generator.writable.getWriter(),
    decoder=new AudioDecoder({
      output: audioData => {
        fardWrap(audioData);
        const nowwow=Date.now();
        avgDecodeTime=(avgDecodeTime+(nowwow-lastDecodeTime))/2;
        lastDecodeTime=nowwow;
      },
      error: e => console.error(e)
    }),
    doneit=false,
    far=true;

decoder.configure({
  codec: "mp3",
  sampleRate: 44100,
  numberOfChannels: 2
});

const cmn = context.createChannelMerger(1);
(new MediaStreamAudioSourceNode(context, {mediaStream: new MediaStream([generator])})).connect(cmn);
panner.maxDistance=16.1;
panner.rolloffFactor=1;
panner.distanceModel="linear";
panner.panningModel="HRTF";
panner.coneInnerAngle=30;
panner.coneOuterAngle=45;
panner.coneOuterGain=0;
panner.orientationX.value=0;
panner.orientationY.value=0;
panner.orientationZ.value=0;
panner.positionX.value=0;
panner.positionY.value=0;
panner.positionZ.value=0;
cmn.connect(panner);
panner.connect(context.destination);
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
var lastTime = Date.now();
var avgTime = 0;
function doit(elem){
  if(doneit)return;
  var uname=prompt("Please enter your username in-game:",getCookie("uname"));
  if(!uname)return;
  if(!uname.match(/^[a-zA-Z0-9_]{2,16}$/))return;
  doneit=true;
  document.cookie="uname="+uname;
  elem.outerHTML="";
  var socket=new WebSocket("ws"+window.location.origin.slice(4)+"/audio");
  socket.binaryType='arraybuffer';
  socket.onopen=()=>{
    socket.send(uname);
  };
  socket.onmessage=e=>{
    if(typeof e.data=="string"){
      var pos=e.data.split(",");
      if(isNaN(+pos[0])){
        far=true;
      }else{
        far=false;
        panner.positionX.value=+pos[0];
        panner.positionY.value=+pos[1];
        panner.positionZ.value=+pos[2];
      }
    }else{
      if(!far){
        decoder.decode(new EncodedAudioChunk({type:'key',data:e.data,timestamp:0,duration:0}));
        const nowwow=Date.now();
        avgTime=(avgTime+(nowwow-lastTime))/2;
        lastTime=nowwow;
      }
    }
  };
}
function fard() {
  for (let i = 0; i < Math.min(queue.length, avgTime / avgDecodeTime); i++) writer.write(queue.shift());
  setTimeout(fard, 0);
}
function fardWrap(ad) {
  if (queue.length > 100) {
    writer.write(ad);
  } else {
    queue.push(ad);
  }
}
fard();
</script>
</body>
</html>
